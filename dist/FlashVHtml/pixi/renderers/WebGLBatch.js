var PIXI=window.PIXI;PIXI._batchs=[],PIXI._getBatch=function(t){return 0==PIXI._batchs.length?new PIXI.WebGLBatch(t):PIXI._batchs.pop()},PIXI._returnBatch=function(t){t.clean(),PIXI._batchs.push(t)},PIXI._restoreBatchs=function(t){for(var e=0;e<PIXI._batchs.length;e++)PIXI._batchs[e].restoreLostContext(t)},PIXI.WebGLBatch=function(t){this.gl=t,this.size=0,this.vertexBuffer=t.createBuffer(),this.indexBuffer=t.createBuffer(),this.uvBuffer=t.createBuffer(),this.colorBuffer=t.createBuffer(),this.blendMode=PIXI.blendModes.NORMAL,this.dynamicSize=1},PIXI.WebGLBatch.constructor=PIXI.WebGLBatch,PIXI.WebGLBatch.prototype.clean=function(){this.verticies=[],this.uvs=[],this.indices=[],this.colors=[],this.dynamicSize=1,this.texture=null,this.last=null,this.size=0,this.head,this.tail},PIXI.WebGLBatch.prototype.restoreLostContext=function(t){this.gl=t,this.vertexBuffer=t.createBuffer(),this.indexBuffer=t.createBuffer(),this.uvBuffer=t.createBuffer(),this.colorBuffer=t.createBuffer()},PIXI.WebGLBatch.prototype.init=function(t){t.batch=this,this.dirty=!0,this.blendMode=t.blendMode,this.texture=t.texture.baseTexture,this.head=t,this.tail=t,this.size=1,this.growBatch()},PIXI.WebGLBatch.prototype.insertBefore=function(t,e){this.size++,t.batch=this,this.dirty=!0;var i=e.__prev;e.__prev=t,t.__next=e,i?(t.__prev=i,i.__next=t):this.head=t},PIXI.WebGLBatch.prototype.insertAfter=function(t,e){this.size++,t.batch=this,this.dirty=!0;var i=e.__next;e.__next=t,t.__prev=e,i?(t.__next=i,i.__prev=t):this.tail=t},PIXI.WebGLBatch.prototype.remove=function(t){if(this.size--,0==this.size)return t.__prev=null,void(t.__next=null);t.__prev?t.__prev.__next=t.__next:this.head=t.__next,t.__next?t.__next.__prev=t.__prev:this.tail=t.__prev,t.batch=null,t.__next=null,t.__prev=null,this.dirty=!0},PIXI.WebGLBatch.prototype.split=function(t){this.dirty=!0;var e=new PIXI.WebGLBatch(this.gl);e.init(t),e.tail=this.tail,this.tail=t.__prev,this.tail.__next=null,t.__prev=null;for(var i=0;t;)i++,t.batch=e,t=t.__next;return e.size=i,this.size-=i,e},PIXI.WebGLBatch.prototype.merge=function(t){this.dirty=!0,this.tail.__next=t.head,t.head.__prev=this.tail,this.size+=t.size,this.tail=t.tail;for(var e=t.head;e;)e.batch=this,e=e.__next},PIXI.WebGLBatch.prototype.growBatch=function(){var t=this.gl;1==this.size?this.dynamicSize=1:this.dynamicSize=1.5*this.size,this.verticies=new Float32Array(8*this.dynamicSize),t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferData(t.ARRAY_BUFFER,this.verticies,t.DYNAMIC_DRAW),this.uvs=new Float32Array(8*this.dynamicSize),t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer),t.bufferData(t.ARRAY_BUFFER,this.uvs,t.DYNAMIC_DRAW),this.dirtyUVS=!0,this.colors=new Float32Array(4*this.dynamicSize),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),t.bufferData(t.ARRAY_BUFFER,this.colors,t.DYNAMIC_DRAW),this.dirtyColors=!0,this.indices=new Uint16Array(6*this.dynamicSize);for(var e=this.indices.length/6,i=0;i<e;i++){var s=6*i,r=4*i;this.indices[s+0]=r+0,this.indices[s+1]=r+1,this.indices[s+2]=r+2,this.indices[s+3]=r+0,this.indices[s+4]=r+2,this.indices[s+5]=r+3}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.indices,t.STATIC_DRAW)},PIXI.WebGLBatch.prototype.refresh=function(){this.gl,this.dynamicSize<this.size&&this.growBatch();for(var t,e=0,i=this.head;i;){t=8*e;var s=i.texture,r=s.frame,h=s.baseTexture.width,a=s.baseTexture.height;this.uvs[t+0]=r.x/h,this.uvs[t+1]=r.y/a,this.uvs[t+2]=(r.x+r.width)/h,this.uvs[t+3]=r.y/a,this.uvs[t+4]=(r.x+r.width)/h,this.uvs[t+5]=(r.y+r.height)/a,this.uvs[t+6]=r.x/h,this.uvs[t+7]=(r.y+r.height)/a,i.updateFrame=!1,colorIndex=4*e,this.colors[colorIndex]=this.colors[colorIndex+1]=this.colors[colorIndex+2]=this.colors[colorIndex+3]=i.worldAlpha,i=i.__next,e++}this.dirtyUVS=!0,this.dirtyColors=!0},PIXI.WebGLBatch.prototype.update=function(){this.gl;for(var t,e,i,s,r,h,a,o,n,c,u,f,_,d,l,v,I=0,B=this.head;B;){if(e=B.width,i=B.height,h=e*(1-(s=B.anchor.x)),a=e*-s,o=i*(1-(r=B.anchor.y)),n=i*-r,c=8*I,u=(t=B.worldTransform)[0],f=t[3],_=t[1],d=t[4],l=t[2],v=t[5],this.verticies[c+0]=u*a+_*n+l,this.verticies[c+1]=d*n+f*a+v,this.verticies[c+2]=u*h+_*n+l,this.verticies[c+3]=d*n+f*h+v,this.verticies[c+4]=u*h+_*o+l,this.verticies[c+5]=d*o+f*h+v,this.verticies[c+6]=u*a+_*o+l,this.verticies[c+7]=d*o+f*a+v,B.updateFrame){this.dirtyUVS=!0;var b=B.texture,x=b.frame,A=b.baseTexture.width,R=b.baseTexture.height;this.uvs[c+0]=x.x/A,this.uvs[c+1]=x.y/R,this.uvs[c+2]=(x.x+x.width)/A,this.uvs[c+3]=x.y/R,this.uvs[c+4]=(x.x+x.width)/A,this.uvs[c+5]=(x.y+x.height)/R,this.uvs[c+6]=x.x/A,this.uvs[c+7]=(x.y+x.height)/R,B.updateFrame=!1}if(B.cacheAlpha!=B.alpha){B.cacheAlpha=B.alpha;var p=4*I;this.colors[p]=this.colors[p+1]=this.colors[p+2]=this.colors[p+3]=B.worldAlpha,this.dirtyColors=!0}I++,B=B.__next}},PIXI.WebGLBatch.prototype.render=function(){if(this.dirty&&(this.refresh(),this.dirty=!1),0!=this.size){this.update();var t=this.gl;this.blendMode==PIXI.blendModes.NORMAL?t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA):t.blendFunc(t.ONE,t.ONE_MINUS_SRC_COLOR);var e=PIXI.shaderProgram;t.bindBuffer(t.ARRAY_BUFFER,this.vertexBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,this.verticies),t.vertexAttribPointer(e.vertexPositionAttribute,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,this.uvBuffer),this.dirtyUVS&&(this.dirtyUVS=!1,t.bufferSubData(t.ARRAY_BUFFER,0,this.uvs)),t.vertexAttribPointer(e.textureCoordAttribute,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,this.texture._glTexture),t.bindBuffer(t.ARRAY_BUFFER,this.colorBuffer),this.dirtyColors&&(this.dirtyColors=!1,t.bufferSubData(t.ARRAY_BUFFER,0,this.colors)),t.vertexAttribPointer(e.colorAttribute,1,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer),t.drawElements(t.TRIANGLES,6*this.size,t.UNSIGNED_SHORT,0)}};