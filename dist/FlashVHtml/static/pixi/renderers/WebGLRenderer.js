var PIXI=PIXI||{};PIXI._defaultFrame={x:0,y:0,width:1,height:1},PIXI.WebGLRenderer=function(e,t){this.width=e||800,this.height=t||600,this.view=document.createElement("canvas"),this.view.width=this.width,this.view.height=this.height,this.view.background="#FF0000";var r=this;this.view.addEventListener("webglcontextlost",(function(e){r.handleContextLost(e)}),!1),this.view.addEventListener("webglcontextrestored",(function(e){r.handleContextRestored(e)}),!1),this.batchs=[];try{this.gl=this.view.getContext("experimental-webgl",{alpha:!1})}catch(e){alert("Web GL only im afraid :/")}this.initShaders();var i=this.gl;this.batch=new PIXI.WebGLBatch(i),i.disable(i.DEPTH_TEST),i.enable(i.BLEND),i.colorMask(!0,!0,!0,!1),this.projectionMatrix=mat4.create(),this.resize(this.width,this.height),this.contextLost=!1},PIXI.WebGLRenderer.constructor=PIXI.WebGLRenderer,PIXI.WebGLRenderer.prototype.initShaders=function(){var e=this.gl,t=PIXI.CompileFragmentShader(e,PIXI.shaderFragmentSrc),r=PIXI.CompileVertexShader(e,PIXI.shaderVertexSrc);this.shaderProgram=e.createProgram();var i=this.shaderProgram;e.attachShader(i,r),e.attachShader(i,t),e.linkProgram(i),e.getProgramParameter(i,e.LINK_STATUS)||alert("Could not initialise shaders"),e.useProgram(i),i.vertexPositionAttribute=e.getAttribLocation(i,"aVertexPosition"),e.enableVertexAttribArray(i.vertexPositionAttribute),i.textureCoordAttribute=e.getAttribLocation(i,"aTextureCoord"),e.enableVertexAttribArray(i.textureCoordAttribute),i.colorAttribute=e.getAttribLocation(i,"aColor"),e.enableVertexAttribArray(i.colorAttribute),i.mvMatrixUniform=e.getUniformLocation(i,"uMVMatrix"),i.samplerUniform=e.getUniformLocation(i,"uSampler"),PIXI.shaderProgram=this.shaderProgram},PIXI.WebGLRenderer.prototype.checkVisibility=function(e){for(var t=e.children,r=0;r<t.length;r++){var i=t[r];i.textureChange&&(i.textureChange=!1,i.visible&&(this.removeDisplayObject(i),this.addDisplayObject(i))),i.cacheVisible==i.visible?i.children.length>0&&this.checkVisibility(i):(i.cacheVisible=i.visible,i.visible?this.addDisplayObject(i):this.removeDisplayObject(i),this.setGLVisible(i,i.visible))}},PIXI.WebGLRenderer.prototype.setGLVisible=function(e,t){for(var r=e.children,i=0;i<r.length;i++){var a=r[i];t?this.addDisplayObject(a):this.removeDisplayObject(a),a.children.length>0&&this.setGLVisible(a,t)}},PIXI.WebGLRenderer.prototype.render=function(e){if(!this.contextLost){for(var t=0;t<e.__childrenRemoved.length;t++)this.removeDisplayObject(e.__childrenRemoved[t]);for(t=0;t<e.__childrenAdded.length;t++)this.addDisplayObject(e.__childrenAdded[t]);for(t=0;t<PIXI.texturesToUpdate.length;t++)this.updateTexture(PIXI.texturesToUpdate[t]);e.__childrenRemoved=[],e.__childrenAdded=[],PIXI.texturesToUpdate=[],this.checkVisibility(e),e.updateTransform();var r,i=this.gl;for(i.clear(i.COLOR_BUFFER_BIT),i.clearColor(0,0,0,1),i.blendFunc(i.ONE,i.ONE_MINUS_SRC_ALPHA),i.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,!1,this.projectionMatrix),t=0;t<this.batchs.length;t++)(r=this.batchs[t])instanceof PIXI.WebGLBatch?this.batchs[t].render():r instanceof PIXI.Strip&&r.visible&&this.renderStrip(r)}},PIXI.WebGLRenderer.prototype.updateTexture=function(e){var t=this.gl;e._glTexture||(e._glTexture=t.createTexture()),e.hasLoaded&&(t.bindTexture(t.TEXTURE_2D,e._glTexture),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e.image),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.bindTexture(t.TEXTURE_2D,null)),this.refreshBatchs=!0},PIXI.WebGLRenderer.prototype.addDisplayObject=function(e){if(e.stage&&(e.cacheVisible=e.visible,e.visible&&(e.batch=null,e.renderable))){e.__inWebGL=!0;var t=e;do{if(0==t.childIndex)t=t.parent;else for(t=t.parent.children[t.childIndex-1];0!=t.children.length;)t=t.children[t.children.length-1];if(t==e.stage)break}while(!t.renderable||!t.__inWebGL);var r=e;do{if(0==r.children.length){for(;r.childIndex==r.parent.children.length-1;)if((r=r.parent)==e.stage){r=null;break}r&&(r=r.parent.children[r.childIndex+1])}else r=r.children[0];if(!r)break}while(!r.renderable||!r.__inWebGL);if(e instanceof PIXI.Sprite){var i,a;if(t instanceof PIXI.Sprite){if((i=t.batch)&&i.texture==e.texture.baseTexture&&i.blendMode==e.blendMode)return void i.insertAfter(e,t)}else i=t;if(r)if(r instanceof PIXI.Sprite){if(a=r.batch){if(a.texture==e.texture.baseTexture&&a.blendMode==e.blendMode)return void a.insertBefore(e,r);if(a==i){var s=i.split(r),n=PIXI._getBatch(this.gl),h=this.batchs.indexOf(i);return n.init(e),void this.batchs.splice(h+1,0,n,s)}}}else a=r;(n=PIXI._getBatch(this.gl)).init(e),i?(h=this.batchs.indexOf(i),this.batchs.splice(h+1,0,n)):this.batchs.push(n)}else e instanceof PIXI.Strip&&(this.initStrip(e),this.batchs.push(e));this.batchUpdate=!0}},PIXI.WebGLRenderer.prototype.removeDisplayObject=function(e){if(e.cacheVisible=e.visible,e.renderable){var t;if(e instanceof PIXI.Sprite){var r=e.batch;if(!r)return;r.remove(e),0==r.size&&(t=r)}else t=e;if(t){var i=this.batchs.indexOf(t);if(-1==i)return;if(0==i||i==this.batchs.length-1)return this.batchs.splice(i,1),void(t instanceof PIXI.WebGLBatch&&PIXI._returnBatch(t));if(this.batchs[i-1]instanceof PIXI.WebGLBatch&&this.batchs[i+1]instanceof PIXI.WebGLBatch&&this.batchs[i-1].texture==this.batchs[i+1].texture)return console.log("MERGE"),this.batchs[i-1].merge(this.batchs[i+1]),t instanceof PIXI.WebGLBatch&&PIXI._returnBatch(t),PIXI._returnBatch(this.batchs[i+1]),void this.batchs.splice(i,2);this.batchs.splice(i,1),t instanceof PIXI.WebGLBatch&&PIXI._returnBatch(t)}}},PIXI.WebGLRenderer.prototype.resize=function(e,t){this.width=e,this.height=t,this.view.width=e,this.view.height=t,this.gl.viewport(0,0,this.width,this.height),mat4.identity(this.projectionMatrix),mat4.scale(this.projectionMatrix,[2/this.width,-2/this.height,1]),mat4.translate(this.projectionMatrix,[-this.width/2,-this.height/2,0])},PIXI.WebGLRenderer.prototype.initStrip=function(e){var t=this.gl;this.shaderProgram,e._vertexBuffer=t.createBuffer(),e._indexBuffer=t.createBuffer(),e._uvBuffer=t.createBuffer(),e._colorBuffer=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,e._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,e.verticies,t.DYNAMIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,e._uvBuffer),t.bufferData(t.ARRAY_BUFFER,e.uvs,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,e._colorBuffer),t.bufferData(t.ARRAY_BUFFER,e.colors,t.STATIC_DRAW),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW)};var bloop=!0;PIXI.WebGLRenderer.prototype.renderStrip=function(e){var t=this.gl,r=this.shaderProgram,i=mat3.toMat4(e.worldTransform);mat4.transpose(i),mat4.multiply(this.projectionMatrix,i,i),t.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,!1,i),e.blendMode==PIXI.blendModes.NORMAL?t.blendFunc(t.ONE,t.ONE_MINUS_SRC_ALPHA):t.blendFunc(t.ONE,t.ONE_MINUS_SRC_COLOR),e.dirty?(e.dirty=!1,t.bindBuffer(t.ARRAY_BUFFER,e._vertexBuffer),t.bufferData(t.ARRAY_BUFFER,e.verticies,t.STATIC_DRAW),t.vertexAttribPointer(r.vertexPositionAttribute,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,e._uvBuffer),t.bufferData(t.ARRAY_BUFFER,e.uvs,t.STATIC_DRAW),t.vertexAttribPointer(r.textureCoordAttribute,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.texture.baseTexture._glTexture),t.bindBuffer(t.ARRAY_BUFFER,e._colorBuffer),t.bufferData(t.ARRAY_BUFFER,e.colors,t.STATIC_DRAW),t.vertexAttribPointer(r.colorAttribute,1,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e._indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,e.indices,t.STATIC_DRAW)):(t.bindBuffer(t.ARRAY_BUFFER,e._vertexBuffer),t.bufferSubData(t.ARRAY_BUFFER,0,e.verticies),t.vertexAttribPointer(r.vertexPositionAttribute,2,t.FLOAT,!1,0,0),t.bindBuffer(t.ARRAY_BUFFER,e._uvBuffer),t.vertexAttribPointer(r.textureCoordAttribute,2,t.FLOAT,!1,0,0),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,e.texture.baseTexture._glTexture),t.bindBuffer(t.ARRAY_BUFFER,e._colorBuffer),t.vertexAttribPointer(r.colorAttribute,1,t.FLOAT,!1,0,0),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e._indexBuffer)),t.drawElements(t.TRIANGLE_STRIP,e.indices.length,t.UNSIGNED_SHORT,0),t.uniformMatrix4fv(this.shaderProgram.mvMatrixUniform,!1,this.projectionMatrix)},PIXI.WebGLRenderer.prototype.handleContextLost=function(e){e.preventDefault(),this.contextLost=!0},PIXI.WebGLRenderer.prototype.handleContextRestored=function(e){this.gl=this.view.getContext("experimental-webgl",{alpha:!0}),this.initShaders();for(var t=0;t<PIXI.TextureCache.length;t++)this.updateTexture(PIXI.TextureCache[t]);for(t=0;t<this.batchs.length;t++)this.batchs[t].restoreLostContext(this.gl),this.batchs[t].dirty=!0;PIXI._restoreBatchs(this.gl),this.contextLost=!1};